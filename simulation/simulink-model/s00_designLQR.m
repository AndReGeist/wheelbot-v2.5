% Script for designing the LQR controller given the wheelbots dynamics model
clear; close all; clc;

run('./s00_config.m') % Load wheelbot parameters

const_values = [Mw; Mc; Mp;...
             Iwx; Iwy; Iwz;...
             Icx; Icy; Icz;...
             Ipx; Ipy; Ipz;...
             Rw; Lc; Lcp; Lp; g];

% Use derived symbolic model
syms Mw Mc Mp ... % Body masses
     Iwx Iwy Iwz ... % Body inertias
     Icx Icy Icz ...
     Ipx Ipy Ipz ...
     Rw Lc Lcp Lp g ... % System geometry and physical constants
     Tw Tp % Actuation Torques
syms q1 q2 q3 q4 q5
syms q1_d q2_d q3_d q4_d q5_d x_d y_d 
syms q1_dd q2_dd q3_dd q4_dd q5_dd x_dd y_dd
q_v = [q1; q2; q3; q4; q5];
dq_v = [q1_d; q2_d; q3_d; q4_d; q5_d];
ddq_v = [q1_dd; q2_dd; q3_dd; q4_dd; q5_dd];

M = [                                                                                                                         Icz + Ipy + Iwx + Lp^2*Mp + Mc*Rw^2 + Mp*Rw^2 + Mw*Rw^2 + Icx*cos(q2)^2 - Icz*cos(q2)^2 + Ipx*cos(q2)^2 - Ipy*cos(q2)^2 - Ipy*cos(q5)^2 + Ipz*cos(q5)^2 + Ipy*cos(q2)^2*cos(q5)^2 - Ipz*cos(q2)^2*cos(q5)^2 + Lc^2*Mc*cos(q2)^2 + Lc^2*Mp*cos(q2)^2 + Lcp^2*Mp*cos(q2)^2 - Lp^2*Mp*cos(q5)^2 + 2*Lc*Mc*Rw*cos(q2) + 2*Lc*Mp*Rw*cos(q2) + 2*Lcp*Mp*Rw*cos(q2) + 2*Lc*Lcp*Mp*cos(q2)^2 + Lp^2*Mp*cos(q2)^2*cos(q5)^2 + 2*Lc*Lp*Mp*cos(q2)^2*cos(q5) + 2*Lcp*Lp*Mp*cos(q2)^2*cos(q5) + 2*Lp*Mp*Rw*cos(q2)*cos(q5),                                                                                                                                                                                                                                                                                                                                                                                                              Ipy*cos(q5)*sin(q2)*sin(q5) - Ipz*cos(q5)*sin(q2)*sin(q5) + Lc*Lp*Mp*sin(q2)*sin(q5) + Lcp*Lp*Mp*sin(q2)*sin(q5) + Lp^2*Mp*cos(q5)*sin(q2)*sin(q5),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Icz*cos(q1)*cos(q2)*sin(q2) - Icx*cos(q1)*cos(q2)*sin(q2) - Ipx*cos(q1)*cos(q2)*sin(q2) + Ipy*cos(q1)*cos(q2)*sin(q2) - Lc*Mc*Rw*cos(q1)*sin(q2) - Lc*Mp*Rw*cos(q1)*sin(q2) - Lcp*Mp*Rw*cos(q1)*sin(q2) + Ipy*cos(q5)*sin(q1)*sin(q2)*sin(q5) - Ipz*cos(q5)*sin(q1)*sin(q2)*sin(q5) - Ipy*cos(q1)*cos(q2)*cos(q5)^2*sin(q2) + Ipz*cos(q1)*cos(q2)*cos(q5)^2*sin(q2) - Lc^2*Mc*cos(q1)*cos(q2)*sin(q2) - Lc^2*Mp*cos(q1)*cos(q2)*sin(q2) - Lcp^2*Mp*cos(q1)*cos(q2)*sin(q2) - Lp^2*Mp*cos(q1)*cos(q2)*cos(q5)^2*sin(q2) - 2*Lc*Lcp*Mp*cos(q1)*cos(q2)*sin(q2) - Lp*Mp*Rw*cos(q1)*cos(q5)*sin(q2) + Lp^2*Mp*cos(q5)*sin(q1)*sin(q2)*sin(q5) + Lc*Lp*Mp*sin(q1)*sin(q2)*sin(q5) + Lcp*Lp*Mp*sin(q1)*sin(q2)*sin(q5) - 2*Lc*Lp*Mp*cos(q1)*cos(q2)*cos(q5)*sin(q2) - 2*Lcp*Lp*Mp*cos(q1)*cos(q2)*cos(q5)*sin(q2),                                                                                                                                                                                                                 0,                                                   Ipx*cos(q2) + Lp^2*Mp*cos(q2) + Lp*Mp*Rw*cos(q5) + Lc*Lp*Mp*cos(q2)*cos(q5) + Lcp*Lp*Mp*cos(q2)*cos(q5);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   sin(q2)*sin(q5)*(Ipy*cos(q5) - Ipz*cos(q5) + Lp^2*Mp*cos(q5) + Lc*Lp*Mp + Lcp*Lp*Mp),                                                                                                                                                                                                                                                                                                                                                                                                           Icy + Ipz + Lc^2*Mc + Lc^2*Mp + Lcp^2*Mp + Ipy*cos(q5)^2 - Ipz*cos(q5)^2 + 2*Lc*Lcp*Mp + Lp^2*Mp*cos(q5)^2 + 2*Lc*Lp*Mp*cos(q5) + 2*Lcp*Lp*Mp*cos(q5),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Icy*sin(q1) + Ipz*sin(q1) + Lc^2*Mc*sin(q1) + Lc^2*Mp*sin(q1) + Lcp^2*Mp*sin(q1) + Ipy*cos(q5)^2*sin(q1) - Ipz*cos(q5)^2*sin(q1) + 2*Lc*Lcp*Mp*sin(q1) + Lp^2*Mp*cos(q5)^2*sin(q1) + Lc*Mc*Rw*cos(q2)*sin(q1) + Lc*Mp*Rw*cos(q2)*sin(q1) + Lcp*Mp*Rw*cos(q2)*sin(q1) + Ipy*cos(q1)*cos(q2)*cos(q5)*sin(q5) - Ipz*cos(q1)*cos(q2)*cos(q5)*sin(q5) + 2*Lc*Lp*Mp*cos(q5)*sin(q1) + 2*Lcp*Lp*Mp*cos(q5)*sin(q1) + Lp^2*Mp*cos(q1)*cos(q2)*cos(q5)*sin(q5) + Lc*Lp*Mp*cos(q1)*cos(q2)*sin(q5) + Lcp*Lp*Mp*cos(q1)*cos(q2)*sin(q5) + Lp*Mp*Rw*cos(q2)*cos(q5)*sin(q1),                                                                                                                                Lc*Mc*Rw*cos(q2) + Lc*Mp*Rw*cos(q2) + Lcp*Mp*Rw*cos(q2) + Lp*Mp*Rw*cos(q2)*cos(q5),                                                                                                                                                         0;
 -sin(q2)*(Icx*cos(q1)*cos(q2) - Icz*cos(q1)*cos(q2) + Ipx*cos(q1)*cos(q2) - Ipy*cos(q1)*cos(q2) + Lc^2*Mc*cos(q1)*cos(q2) + Lc^2*Mp*cos(q1)*cos(q2) + Lcp^2*Mp*cos(q1)*cos(q2) + Lc*Mc*Rw*cos(q1) + Lc*Mp*Rw*cos(q1) + Lcp*Mp*Rw*cos(q1) - Ipy*cos(q5)*sin(q1)*sin(q5) + Ipz*cos(q5)*sin(q1)*sin(q5) + Ipy*cos(q1)*cos(q2)*cos(q5)^2 - Ipz*cos(q1)*cos(q2)*cos(q5)^2 - Lc*Lp*Mp*sin(q1)*sin(q5) - Lcp*Lp*Mp*sin(q1)*sin(q5) + Lp^2*Mp*cos(q1)*cos(q2)*cos(q5)^2 + 2*Lc*Lcp*Mp*cos(q1)*cos(q2) + Lp*Mp*Rw*cos(q1)*cos(q5) - Lp^2*Mp*cos(q5)*sin(q1)*sin(q5) + 2*Lc*Lp*Mp*cos(q1)*cos(q2)*cos(q5) + 2*Lcp*Lp*Mp*cos(q1)*cos(q2)*cos(q5)), Icy*sin(q1) + Ipz*sin(q1) + Lc^2*Mc*sin(q1) + Lc^2*Mp*sin(q1) + Lcp^2*Mp*sin(q1) + Ipy*cos(q5)^2*sin(q1) - Ipz*cos(q5)^2*sin(q1) + 2*Lc*Lcp*Mp*sin(q1) + Lp^2*Mp*cos(q5)^2*sin(q1) + Lc*Mc*Rw*cos(q2)*sin(q1) + Lc*Mp*Rw*cos(q2)*sin(q1) + Lcp*Mp*Rw*cos(q2)*sin(q1) + Ipy*cos(q1)*cos(q2)*cos(q5)*sin(q5) - Ipz*cos(q1)*cos(q2)*cos(q5)*sin(q5) + 2*Lc*Lp*Mp*cos(q5)*sin(q1) + 2*Lcp*Lp*Mp*cos(q5)*sin(q1) + Lp^2*Mp*cos(q1)*cos(q2)*cos(q5)*sin(q5) + Lc*Lp*Mp*cos(q1)*cos(q2)*sin(q5) + Lcp*Lp*Mp*cos(q1)*cos(q2)*sin(q5) + Lp*Mp*Rw*cos(q2)*cos(q5)*sin(q1), Icy + Ipz + Iwy + Lc^2*Mc + Lc^2*Mp + Lcp^2*Mp + Mc*Rw^2 + Mp*Rw^2 + Mw*Rw^2 + Icx*cos(q1)^2 - Icy*cos(q1)^2 + Ipx*cos(q1)^2 + Ipy*cos(q5)^2 - Ipz*cos(q1)^2 - Ipz*cos(q5)^2 - Iwy*cos(q1)^2 + Iwz*cos(q1)^2 - Icx*cos(q1)^2*cos(q2)^2 + Icz*cos(q1)^2*cos(q2)^2 - Ipx*cos(q1)^2*cos(q2)^2 + Ipy*cos(q1)^2*cos(q2)^2 - Ipy*cos(q1)^2*cos(q5)^2 + Ipz*cos(q1)^2*cos(q5)^2 + 2*Lc*Lcp*Mp + Lp^2*Mp*cos(q1)^2 + Lp^2*Mp*cos(q5)^2 - Mc*Rw^2*cos(q1)^2 - Mp*Rw^2*cos(q1)^2 - Mw*Rw^2*cos(q1)^2 + 2*Lc*Lp*Mp*cos(q5) + 2*Lcp*Lp*Mp*cos(q5) + 2*Lc*Mc*Rw*cos(q2) + 2*Lc*Mp*Rw*cos(q2) + 2*Lcp*Mp*Rw*cos(q2) - Ipy*cos(q1)^2*cos(q2)^2*cos(q5)^2 + Ipz*cos(q1)^2*cos(q2)^2*cos(q5)^2 - Lc^2*Mc*cos(q1)^2*cos(q2)^2 - Lc^2*Mp*cos(q1)^2*cos(q2)^2 - Lcp^2*Mp*cos(q1)^2*cos(q2)^2 - Lp^2*Mp*cos(q1)^2*cos(q5)^2 - 2*Lc*Mc*Rw*cos(q1)^2*cos(q2) - 2*Lc*Mp*Rw*cos(q1)^2*cos(q2) - 2*Lcp*Mp*Rw*cos(q1)^2*cos(q2) - 2*Lc*Lcp*Mp*cos(q1)^2*cos(q2)^2 - Lp^2*Mp*cos(q1)^2*cos(q2)^2*cos(q5)^2 + 2*Lp*Mp*Rw*cos(q2)*cos(q5) - 2*Lp*Mp*Rw*cos(q1)^2*cos(q2)*cos(q5) - 2*Lc*Lp*Mp*cos(q1)^2*cos(q2)^2*cos(q5) - 2*Lcp*Lp*Mp*cos(q1)^2*cos(q2)^2*cos(q5) + 2*Lp*Mp*Rw*cos(q1)*sin(q1)*sin(q5) + 2*Ipy*cos(q1)*cos(q2)*cos(q5)*sin(q1)*sin(q5) - 2*Ipz*cos(q1)*cos(q2)*cos(q5)*sin(q1)*sin(q5) + 2*Lp^2*Mp*cos(q1)*cos(q2)*cos(q5)*sin(q1)*sin(q5) + 2*Lc*Lp*Mp*cos(q1)*cos(q2)*sin(q1)*sin(q5) + 2*Lcp*Lp*Mp*cos(q1)*cos(q2)*sin(q1)*sin(q5), Iwy*sin(q1) + Mc*Rw^2*sin(q1) + Mp*Rw^2*sin(q1) + Mw*Rw^2*sin(q1) + Lc*Mc*Rw*cos(q2)*sin(q1) + Lc*Mp*Rw*cos(q2)*sin(q1) + Lcp*Mp*Rw*cos(q2)*sin(q1) + Lp*Mp*Rw*cos(q1)*sin(q5) + Lp*Mp*Rw*cos(q2)*cos(q5)*sin(q1), - Ipx*cos(q1)*sin(q2) - Lp^2*Mp*cos(q1)*sin(q2) - Lc*Lp*Mp*cos(q1)*cos(q5)*sin(q2) - Lcp*Lp*Mp*cos(q1)*cos(q5)*sin(q2) - Lp*Mp*Rw*sin(q1)*sin(q2)*sin(q5);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Lc*Mc*Rw*cos(q2) + Lc*Mp*Rw*cos(q2) + Lcp*Mp*Rw*cos(q2) + Lp*Mp*Rw*cos(q2)*cos(q5),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Iwy*sin(q1) + Mc*Rw^2*sin(q1) + Mp*Rw^2*sin(q1) + Mw*Rw^2*sin(q1) + Lc*Mc*Rw*cos(q2)*sin(q1) + Lc*Mp*Rw*cos(q2)*sin(q1) + Lcp*Mp*Rw*cos(q2)*sin(q1) + Lp*Mp*Rw*cos(q1)*sin(q5) + Lp*Mp*Rw*cos(q2)*cos(q5)*sin(q1),                                                                                                                                                                                 Iwy + Mc*Rw^2 + Mp*Rw^2 + Mw*Rw^2,                                                                                                                                 -Lp*Mp*Rw*sin(q2)*sin(q5);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Ipx*cos(q2) + Lp^2*Mp*cos(q2) + Lp*Mp*Rw*cos(q5) + Lc*Lp*Mp*cos(q2)*cos(q5) + Lcp*Lp*Mp*cos(q2)*cos(q5),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 - Ipx*cos(q1)*sin(q2) - Lp^2*Mp*cos(q1)*sin(q2) - Lc*Lp*Mp*cos(q1)*cos(q5)*sin(q2) - Lcp*Lp*Mp*cos(q1)*cos(q5)*sin(q2) - Lp*Mp*Rw*sin(q1)*sin(q2)*sin(q5),                                                                                                                                                                                         -Lp*Mp*Rw*sin(q2)*sin(q5),                                                                                                                                             Mp*Lp^2 + Ipx];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
RHS = [(Icy*q3_d^2*sin(2*q1))/2 - (Icx*q3_d^2*sin(2*q1))/2 - (Ipx*q3_d^2*sin(2*q1))/2 + (Ipz*q3_d^2*sin(2*q1))/2 + (Iwy*q3_d^2*sin(2*q1))/2 - (Iwz*q3_d^2*sin(2*q1))/2 + Mc*Rw*g*sin(q1) + Mp*Rw*g*sin(q1) + Mw*Rw*g*sin(q1) - Icx*q2_d*q3_d*cos(q1) + Icy*q2_d*q3_d*cos(q1) + Icz*q2_d*q3_d*cos(q1) - Ipx*q2_d*q3_d*cos(q1) + Ipy*q2_d*q3_d*cos(q1) + Ipz*q2_d*q3_d*cos(q1) + Iwy*q3_d*q4_d*cos(q1) - (Lp^2*Mp*q3_d^2*sin(2*q1))/2 + Ipx*q2_d*q5_d*sin(q2) + Ipy*q2_d*q5_d*sin(q2) - Ipz*q2_d*q5_d*sin(q2) + (Mc*Rw^2*q3_d^2*sin(2*q1))/2 + (Mp*Rw^2*q3_d^2*sin(2*q1))/2 + (Mw*Rw^2*q3_d^2*sin(2*q1))/2 + Icx*q1_d*q2_d*sin(2*q2) - Icz*q1_d*q2_d*sin(2*q2) + Ipx*q1_d*q2_d*sin(2*q2) - Ipy*q1_d*q2_d*sin(2*q2) - Ipy*q1_d*q5_d*sin(2*q5) + Ipz*q1_d*q5_d*sin(2*q5) - Lp*Mp*Rw*q3_d^2*sin(q5) + Lp*Mp*Rw*q5_d^2*sin(q5) - Ipy*q2_d^2*cos(q2)*cos(q5)*sin(q5) - Ipy*q3_d^2*cos(q2)*cos(q5)*sin(q5) + Ipz*q2_d^2*cos(q2)*cos(q5)*sin(q5) + Ipz*q3_d^2*cos(q2)*cos(q5)*sin(q5) + Mc*Rw^2*q3_d*q4_d*cos(q1) + Mp*Rw^2*q3_d*q4_d*cos(q1) + Mw*Rw^2*q3_d*q4_d*cos(q1) + Lc*Mc*g*cos(q2)*sin(q1) + Lc*Mp*g*cos(q2)*sin(q1) + Lcp*Mp*g*cos(q2)*sin(q1) + Lp*Mp*g*cos(q1)*sin(q5) + 2*Lp^2*Mp*q2_d*q5_d*sin(q2) + Ipx*q3_d*q5_d*sin(q1)*sin(q2) + Ipy*q3_d*q5_d*sin(q1)*sin(q2) - Ipz*q3_d*q5_d*sin(q1)*sin(q2) + Icx*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) - Icz*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) + Ipx*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) - Ipy*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) + Ipy*q3_d^2*cos(q1)*cos(q5)^2*sin(q1) - Ipz*q3_d^2*cos(q1)*cos(q5)^2*sin(q1) + Lc^2*Mc*q1_d*q2_d*sin(2*q2) + Lc^2*Mp*q1_d*q2_d*sin(2*q2) + Lcp^2*Mp*q1_d*q2_d*sin(2*q2) - Lp^2*Mp*q1_d*q5_d*sin(2*q5) + 2*Icx*q2_d*q3_d*cos(q1)*cos(q2)^2 - 2*Icz*q2_d*q3_d*cos(q1)*cos(q2)^2 + 2*Ipx*q2_d*q3_d*cos(q1)*cos(q2)^2 - 2*Ipy*q2_d*q3_d*cos(q1)*cos(q2)^2 - 2*Ipy*q2_d*q5_d*cos(q5)^2*sin(q2) + 2*Ipz*q2_d*q5_d*cos(q5)^2*sin(q2) + 2*Lp^2*Mp*q3_d*q5_d*sin(q1)*sin(q2) + 2*Lc*Mc*Rw*q1_d*q2_d*sin(q2) + 2*Lc*Mp*Rw*q1_d*q2_d*sin(q2) + 2*Lcp*Mp*Rw*q1_d*q2_d*sin(q2) + Lc^2*Mc*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) + Lc^2*Mp*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) + Lcp^2*Mp*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) + Lp^2*Mp*q3_d^2*cos(q1)*cos(q5)^2*sin(q1) + 2*Lp*Mp*Rw*q3_d^2*cos(q1)^2*sin(q5) + 2*Ipy*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)*sin(q5) - 2*Ipz*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)*sin(q5) + 2*Lc^2*Mc*q2_d*q3_d*cos(q1)*cos(q2)^2 + 2*Lc^2*Mp*q2_d*q3_d*cos(q1)*cos(q2)^2 + 2*Lcp^2*Mp*q2_d*q3_d*cos(q1)*cos(q2)^2 - 2*Lp^2*Mp*q2_d*q5_d*cos(q5)^2*sin(q2) + 2*Lc*Lcp*Mp*q1_d*q2_d*sin(2*q2) + 2*Ipy*q1_d*q2_d*cos(q2)*cos(q5)^2*sin(q2) + 2*Ipy*q1_d*q5_d*cos(q2)^2*cos(q5)*sin(q5) - 2*Ipz*q1_d*q2_d*cos(q2)*cos(q5)^2*sin(q2) - 2*Ipz*q1_d*q5_d*cos(q2)^2*cos(q5)*sin(q5) - 2*Ipy*q3_d*q5_d*cos(q5)^2*sin(q1)*sin(q2) + 2*Ipz*q3_d*q5_d*cos(q5)^2*sin(q1)*sin(q2) + Ipy*q3_d^2*cos(q1)*cos(q2)^2*cos(q5)^2*sin(q1) - Ipz*q3_d^2*cos(q1)*cos(q2)^2*cos(q5)^2*sin(q1) - Lp^2*Mp*q2_d^2*cos(q2)*cos(q5)*sin(q5) - Lp^2*Mp*q3_d^2*cos(q2)*cos(q5)*sin(q5) + 2*Ipy*q2_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2 - 2*Ipz*q2_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2 - Lc*Lp*Mp*q2_d^2*cos(q2)*sin(q5) - Lc*Lp*Mp*q3_d^2*cos(q2)*sin(q5) + Lc*Lp*Mp*q5_d^2*cos(q2)*sin(q5) - Lcp*Lp*Mp*q2_d^2*cos(q2)*sin(q5) - Lcp*Lp*Mp*q3_d^2*cos(q2)*sin(q5) + Lcp*Lp*Mp*q5_d^2*cos(q2)*sin(q5) + Lp*Mp*g*cos(q2)*cos(q5)*sin(q1) + 2*Lc*Lcp*Mp*q3_d^2*cos(q1)*cos(q2)^2*sin(q1) + 2*Lc*Lp*Mp*q3_d^2*cos(q1)^2*cos(q2)*sin(q5) + 2*Lcp*Lp*Mp*q3_d^2*cos(q1)^2*cos(q2)*sin(q5) + 2*Lp^2*Mp*q1_d*q2_d*cos(q2)*cos(q5)^2*sin(q2) + 2*Lp^2*Mp*q1_d*q5_d*cos(q2)^2*cos(q5)*sin(q5) + 4*Lc*Lcp*Mp*q2_d*q3_d*cos(q1)*cos(q2)^2 - 2*Lp^2*Mp*q3_d*q5_d*cos(q5)^2*sin(q1)*sin(q2) + 2*Lc*Lp*Mp*q1_d*q5_d*cos(q2)^2*sin(q5) + 2*Lcp*Lp*Mp*q1_d*q5_d*cos(q2)^2*sin(q5) + Lp^2*Mp*q3_d^2*cos(q1)*cos(q2)^2*cos(q5)^2*sin(q1) + 2*Lp^2*Mp*q2_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2 + 2*Lc*Mc*Rw*q3_d^2*cos(q1)*cos(q2)*sin(q1) + 2*Lc*Mp*Rw*q3_d^2*cos(q1)*cos(q2)*sin(q1) + 2*Lcp*Mp*Rw*q3_d^2*cos(q1)*cos(q2)*sin(q1) + 2*Lc*Mc*Rw*q2_d*q3_d*cos(q1)*cos(q2) + Lc*Mc*Rw*q3_d*q4_d*cos(q1)*cos(q2) + 2*Lc*Mp*Rw*q2_d*q3_d*cos(q1)*cos(q2) + Lc*Mp*Rw*q3_d*q4_d*cos(q1)*cos(q2) + 2*Lcp*Mp*Rw*q2_d*q3_d*cos(q1)*cos(q2) + Lcp*Mp*Rw*q3_d*q4_d*cos(q1)*cos(q2) + 2*Lp*Mp*Rw*q1_d*q2_d*cos(q5)*sin(q2) + 2*Lp*Mp*Rw*q1_d*q5_d*cos(q2)*sin(q5) + 2*Lp^2*Mp*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)*sin(q5) - Lp*Mp*Rw*q3_d*q4_d*sin(q1)*sin(q5) - 2*Ipy*q2_d*q3_d*cos(q2)*cos(q5)*sin(q1)*sin(q5) + 2*Ipz*q2_d*q3_d*cos(q2)*cos(q5)*sin(q1)*sin(q5) + 4*Lc*Lp*Mp*q2_d*q3_d*cos(q1)*cos(q2)^2*cos(q5) + 4*Lcp*Lp*Mp*q2_d*q3_d*cos(q1)*cos(q2)^2*cos(q5) + 2*Lp*Mp*Rw*q3_d^2*cos(q1)*cos(q2)*cos(q5)*sin(q1) + 2*Lp*Mp*Rw*q2_d*q3_d*cos(q1)*cos(q2)*cos(q5) + Lp*Mp*Rw*q3_d*q4_d*cos(q1)*cos(q2)*cos(q5) - 2*Lp^2*Mp*q2_d*q3_d*cos(q2)*cos(q5)*sin(q1)*sin(q5) + 4*Lc*Lp*Mp*q1_d*q2_d*cos(q2)*cos(q5)*sin(q2) + 4*Lcp*Lp*Mp*q1_d*q2_d*cos(q2)*cos(q5)*sin(q2) - 2*Lc*Lp*Mp*q2_d*q3_d*cos(q2)*sin(q1)*sin(q5) - 2*Lcp*Lp*Mp*q2_d*q3_d*cos(q2)*sin(q1)*sin(q5) - 2*Lp*Mp*Rw*q3_d*q5_d*cos(q1)*sin(q2)*sin(q5) - 2*Ipy*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) + 2*Ipz*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) + 2*Lc*Lp*Mp*q3_d^2*cos(q1)*cos(q2)^2*cos(q5)*sin(q1) + 2*Lcp*Lp*Mp*q3_d^2*cos(q1)*cos(q2)^2*cos(q5)*sin(q1) - 2*Lp^2*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) - 2*Lc*Lp*Mp*q3_d*q5_d*cos(q1)*cos(q2)*sin(q2)*sin(q5) - 2*Lcp*Lp*Mp*q3_d*q5_d*cos(q1)*cos(q2)*sin(q2)*sin(q5);     
            (Icz*q1_d^2*sin(2*q2))/2 - (Icx*q1_d^2*sin(2*q2))/2 - Tw - (Ipx*q1_d^2*sin(2*q2))/2 + (Ipy*q1_d^2*sin(2*q2))/2 + Icx*q1_d*q3_d*cos(q1) - Icy*q1_d*q3_d*cos(q1) - Icz*q1_d*q3_d*cos(q1) + Ipx*q1_d*q3_d*cos(q1) - Ipy*q1_d*q3_d*cos(q1) - Ipz*q1_d*q3_d*cos(q1) - (Lc^2*Mc*q1_d^2*sin(2*q2))/2 - (Lc^2*Mp*q1_d^2*sin(2*q2))/2 - (Lcp^2*Mp*q1_d^2*sin(2*q2))/2 - Ipx*q1_d*q5_d*sin(q2) + Ipy*q1_d*q5_d*sin(q2) - Ipz*q1_d*q5_d*sin(q2) + Ipy*q2_d*q5_d*sin(2*q5) - Ipz*q2_d*q5_d*sin(2*q5) - Lc*Mc*Rw*q1_d^2*sin(q2) - Lc*Mc*Rw*q3_d^2*sin(q2) - Lc*Mp*Rw*q1_d^2*sin(q2) - Lc*Mp*Rw*q3_d^2*sin(q2) - Lcp*Mp*Rw*q1_d^2*sin(q2) - Lcp*Mp*Rw*q3_d^2*sin(q2) + Lc*Mc*g*cos(q1)*sin(q2) + Lc*Mp*g*cos(q1)*sin(q2) + Lcp*Mp*g*cos(q1)*sin(q2) - Ipx*q3_d*q5_d*cos(q1)*cos(q2) + Ipy*q3_d*q5_d*cos(q1)*cos(q2) - Ipz*q3_d*q5_d*cos(q1)*cos(q2) - Lc*Lcp*Mp*q1_d^2*sin(2*q2) + Icx*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) - Icz*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) + Ipx*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) - Ipy*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) - Ipy*q1_d^2*cos(q2)*cos(q5)^2*sin(q2) + Ipz*q1_d^2*cos(q2)*cos(q5)^2*sin(q2) + Lp^2*Mp*q2_d*q5_d*sin(2*q5) - 2*Icx*q1_d*q3_d*cos(q1)*cos(q2)^2 + 2*Icz*q1_d*q3_d*cos(q1)*cos(q2)^2 - 2*Ipx*q1_d*q3_d*cos(q1)*cos(q2)^2 + 2*Ipy*q1_d*q3_d*cos(q1)*cos(q2)^2 - 2*Ipy*q1_d*q5_d*cos(q5)^2*sin(q2) + 2*Ipz*q1_d*q5_d*cos(q5)^2*sin(q2) + 2*Lc*Lp*Mp*q2_d*q5_d*sin(q5) + 2*Lcp*Lp*Mp*q2_d*q5_d*sin(q5) + Lc^2*Mc*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) + Lc^2*Mp*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) + Lcp^2*Mp*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) - Lp^2*Mp*q1_d^2*cos(q2)*cos(q5)^2*sin(q2) + 2*Ipy*q3_d*q5_d*cos(q5)*sin(q1)*sin(q5) - 2*Ipz*q3_d*q5_d*cos(q5)*sin(q1)*sin(q5) + Lc*Mc*Rw*q3_d^2*cos(q1)^2*sin(q2) + Lc*Mp*Rw*q3_d^2*cos(q1)^2*sin(q2) + Lcp*Mp*Rw*q3_d^2*cos(q1)^2*sin(q2) - 2*Lc^2*Mc*q1_d*q3_d*cos(q1)*cos(q2)^2 - 2*Lc^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2 - 2*Lcp^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2 - 2*Lp^2*Mp*q1_d*q5_d*cos(q5)^2*sin(q2) - 2*Ipy*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2 + 2*Ipz*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2 + Ipy*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)^2*sin(q2) - Ipz*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)^2*sin(q2) - 2*Ipy*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2 + 2*Ipz*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2 - Lp*Mp*Rw*q1_d^2*cos(q5)*sin(q2) - Lp*Mp*Rw*q3_d^2*cos(q5)*sin(q2) + Lp*Mp*g*cos(q1)*cos(q5)*sin(q2) + 2*Lc*Lcp*Mp*q3_d^2*cos(q1)^2*cos(q2)*sin(q2) + Lp*Mp*Rw*q3_d^2*cos(q1)^2*cos(q5)*sin(q2) - 2*Lp^2*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2 - 4*Lc*Lcp*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2 + Lp^2*Mp*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)^2*sin(q2) - 2*Lp^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2 - 2*Lc*Lp*Mp*q1_d^2*cos(q2)*cos(q5)*sin(q2) - 2*Lcp*Lp*Mp*q1_d^2*cos(q2)*cos(q5)*sin(q2) - Ipy*q3_d^2*cos(q1)*cos(q5)*sin(q1)*sin(q2)*sin(q5) + Ipz*q3_d^2*cos(q1)*cos(q5)*sin(q1)*sin(q2)*sin(q5) - 2*Lc*Mc*Rw*q1_d*q3_d*cos(q1)*cos(q2) - 2*Lc*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2) - 2*Lcp*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2) + 2*Lp^2*Mp*q3_d*q5_d*cos(q5)*sin(q1)*sin(q5) - 2*Lc*Lp*Mp*q1_d*q5_d*cos(q5)*sin(q2) - 2*Lcp*Lp*Mp*q1_d*q5_d*cos(q5)*sin(q2) + 2*Lc*Lp*Mp*q3_d*q5_d*sin(q1)*sin(q5) + 2*Lcp*Lp*Mp*q3_d*q5_d*sin(q1)*sin(q5) - Lc*Mc*Rw*q3_d*q4_d*sin(q1)*sin(q2) - Lc*Mp*Rw*q3_d*q4_d*sin(q1)*sin(q2) - Lcp*Mp*Rw*q3_d*q4_d*sin(q1)*sin(q2) + 2*Ipy*q1_d*q3_d*cos(q2)*cos(q5)*sin(q1)*sin(q5) - 2*Ipz*q1_d*q3_d*cos(q2)*cos(q5)*sin(q1)*sin(q5) - 4*Lc*Lp*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5) - 4*Lcp*Lp*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5) - Lp^2*Mp*q3_d^2*cos(q1)*cos(q5)*sin(q1)*sin(q2)*sin(q5) - Lc*Lp*Mp*q3_d^2*cos(q1)*sin(q1)*sin(q2)*sin(q5) - Lcp*Lp*Mp*q3_d^2*cos(q1)*sin(q1)*sin(q2)*sin(q5) - 2*Lc*Lp*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5) - 2*Lcp*Lp*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5) - 2*Lp*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2)*cos(q5) + 2*Lp^2*Mp*q1_d*q3_d*cos(q2)*cos(q5)*sin(q1)*sin(q5) + 2*Lc*Lp*Mp*q1_d*q3_d*cos(q2)*sin(q1)*sin(q5) + 2*Lcp*Lp*Mp*q1_d*q3_d*cos(q2)*sin(q1)*sin(q5) - Lp*Mp*Rw*q3_d*q4_d*cos(q5)*sin(q1)*sin(q2) + 2*Lc*Lp*Mp*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)*sin(q2) + 2*Lcp*Lp*Mp*q3_d^2*cos(q1)^2*cos(q2)*cos(q5)*sin(q2);      
            Icz*q1_d*q2_d*cos(q1) - Icy*q1_d*q2_d*cos(q1) - Icx*q1_d*q2_d*cos(q1) - Ipx*q1_d*q2_d*cos(q1) + Ipy*q1_d*q2_d*cos(q1) - Ipz*q1_d*q2_d*cos(q1) - Iwy*q1_d*q4_d*cos(q1) + Icx*q1_d*q3_d*sin(2*q1) - Icy*q1_d*q3_d*sin(2*q1) + Ipx*q1_d*q3_d*sin(2*q1) + Ipy*q3_d*q5_d*sin(2*q5) - Ipz*q1_d*q3_d*sin(2*q1) - Ipz*q3_d*q5_d*sin(2*q5) - Iwy*q1_d*q3_d*sin(2*q1) + Iwz*q1_d*q3_d*sin(2*q1) - 2*Lc^2*Mc*q1_d*q2_d*cos(q1) - 2*Lc^2*Mp*q1_d*q2_d*cos(q1) - 2*Lcp^2*Mp*q1_d*q2_d*cos(q1) - Icx*q1_d^2*cos(q2)*sin(q1)*sin(q2) + Icz*q1_d^2*cos(q2)*sin(q1)*sin(q2) - Ipx*q1_d^2*cos(q2)*sin(q1)*sin(q2) + Ipy*q1_d^2*cos(q2)*sin(q1)*sin(q2) + Ipx*q2_d*q5_d*cos(q1)*cos(q2) + Ipy*q2_d*q5_d*cos(q1)*cos(q2) - Ipz*q2_d*q5_d*cos(q1)*cos(q2) - Ipx*q1_d*q5_d*sin(q1)*sin(q2) + Ipy*q1_d*q5_d*sin(q1)*sin(q2) - Ipz*q1_d*q5_d*sin(q1)*sin(q2) + Lp^2*Mp*q1_d*q3_d*sin(2*q1) + Lp^2*Mp*q3_d*q5_d*sin(2*q5) - Mc*Rw^2*q1_d*q3_d*sin(2*q1) - Mp*Rw^2*q1_d*q3_d*sin(2*q1) - Mw*Rw^2*q1_d*q3_d*sin(2*q1) + 2*Icx*q1_d*q2_d*cos(q1)*cos(q2)^2 - 2*Icz*q1_d*q2_d*cos(q1)*cos(q2)^2 + 2*Ipx*q1_d*q2_d*cos(q1)*cos(q2)^2 - 2*Ipy*q1_d*q2_d*cos(q1)*cos(q2)^2 - 2*Ipy*q1_d*q2_d*cos(q1)*cos(q5)^2 + 2*Ipz*q1_d*q2_d*cos(q1)*cos(q5)^2 + 2*Lc*Lp*Mp*q3_d*q5_d*sin(q5) + 2*Lcp*Lp*Mp*q3_d*q5_d*sin(q5) + 2*Lc*Mc*Rw*q2_d*q3_d*sin(q2) - Lc*Mc*Rw*q3_d*q4_d*sin(q2) + 2*Lc*Mp*Rw*q2_d*q3_d*sin(q2) - Lc*Mp*Rw*q3_d*q4_d*sin(q2) + 2*Lcp*Mp*Rw*q2_d*q3_d*sin(q2) - Lcp*Mp*Rw*q3_d*q4_d*sin(q2) + 2*Lp*Mp*Rw*q1_d*q3_d*sin(q5) + 2*Ipy*q3_d*q5_d*cos(q1)*cos(q2)*sin(q1) + 2*Ipy*q1_d*q3_d*cos(q2)*cos(q5)*sin(q5) - 2*Ipz*q3_d*q5_d*cos(q1)*cos(q2)*sin(q1) - 2*Ipz*q1_d*q3_d*cos(q2)*cos(q5)*sin(q5) + 2*Ipy*q2_d*q5_d*cos(q5)*sin(q1)*sin(q5) - 2*Ipz*q2_d*q5_d*cos(q5)*sin(q1)*sin(q5) + 2*Lc^2*Mc*q1_d*q2_d*cos(q1)*cos(q2)^2 + 2*Lc^2*Mp*q1_d*q2_d*cos(q1)*cos(q2)^2 + 2*Lcp^2*Mp*q1_d*q2_d*cos(q1)*cos(q2)^2 - 2*Lp^2*Mp*q1_d*q2_d*cos(q1)*cos(q5)^2 - Ipy*q1_d^2*cos(q2)*cos(q5)^2*sin(q1)*sin(q2) + Ipz*q1_d^2*cos(q2)*cos(q5)^2*sin(q1)*sin(q2) - 2*Ipy*q2_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2 + 2*Ipz*q2_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2 - 2*Icx*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) - 2*Icx*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) + 2*Icz*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) + 2*Icz*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) - 2*Ipx*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) - 2*Ipx*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) + 2*Ipy*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) + 2*Ipy*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) - 2*Ipy*q1_d*q3_d*cos(q1)*cos(q5)^2*sin(q1) - 2*Ipy*q3_d*q5_d*cos(q1)^2*cos(q5)*sin(q5) + 2*Ipz*q1_d*q3_d*cos(q1)*cos(q5)^2*sin(q1) + 2*Ipz*q3_d*q5_d*cos(q1)^2*cos(q5)*sin(q5) - 2*Ipy*q1_d*q5_d*cos(q5)^2*sin(q1)*sin(q2) + 2*Ipz*q1_d*q5_d*cos(q5)^2*sin(q1)*sin(q2) - Lc^2*Mc*q1_d^2*cos(q2)*sin(q1)*sin(q2) - Lc^2*Mp*q1_d^2*cos(q2)*sin(q1)*sin(q2) - Lcp^2*Mp*q1_d^2*cos(q2)*sin(q1)*sin(q2) + 2*Ipy*q1_d*q2_d*cos(q1)*cos(q2)^2*cos(q5)^2 - 2*Ipz*q1_d*q2_d*cos(q1)*cos(q2)^2*cos(q5)^2 + 2*Lp^2*Mp*q2_d*q5_d*cos(q1)*cos(q2) - Lc*Mc*Rw*q1_d^2*sin(q1)*sin(q2) + Lc*Mc*Rw*q2_d^2*sin(q1)*sin(q2) - Lc*Mp*Rw*q1_d^2*sin(q1)*sin(q2) + Lc*Mp*Rw*q2_d^2*sin(q1)*sin(q2) - Lcp*Mp*Rw*q1_d^2*sin(q1)*sin(q2) + Lcp*Mp*Rw*q2_d^2*sin(q1)*sin(q2) - Ipy*q1_d^2*cos(q1)*cos(q5)*sin(q2)*sin(q5) + Ipy*q2_d^2*cos(q1)*cos(q5)*sin(q2)*sin(q5) + Ipz*q1_d^2*cos(q1)*cos(q5)*sin(q2)*sin(q5) - Ipz*q2_d^2*cos(q1)*cos(q5)*sin(q2)*sin(q5) - 4*Lc*Lcp*Mp*q1_d*q2_d*cos(q1) - 2*Lp^2*Mp*q2_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2 - 2*Lc^2*Mc*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) - 2*Lc^2*Mc*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) - 2*Lc^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) - 2*Lc^2*Mp*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) - 2*Lcp^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) - 2*Lcp^2*Mp*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) - 2*Lp^2*Mp*q1_d*q3_d*cos(q1)*cos(q5)^2*sin(q1) - 2*Lp^2*Mp*q3_d*q5_d*cos(q1)^2*cos(q5)*sin(q5) + 4*Lc*Lcp*Mp*q1_d*q2_d*cos(q1)*cos(q2)^2 - 2*Lp^2*Mp*q1_d*q5_d*cos(q5)^2*sin(q1)*sin(q2) - 2*Lc*Mc*Rw*q2_d*q3_d*cos(q1)^2*sin(q2) - 2*Lc*Mp*Rw*q2_d*q3_d*cos(q1)^2*sin(q2) - 2*Lcp*Mp*Rw*q2_d*q3_d*cos(q1)^2*sin(q2) - 4*Lp*Mp*Rw*q1_d*q3_d*cos(q1)^2*sin(q5) - 4*Ipy*q1_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)*sin(q5) - 4*Ipy*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2*sin(q1) + 4*Ipz*q1_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)*sin(q5) + 4*Ipz*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2*sin(q1) + 2*Lp^2*Mp*q1_d*q2_d*cos(q1)*cos(q2)^2*cos(q5)^2 - Lp^2*Mp*q1_d^2*cos(q1)*cos(q5)*sin(q2)*sin(q5) + Lp^2*Mp*q2_d^2*cos(q1)*cos(q5)*sin(q2)*sin(q5) - 2*Ipy*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2*sin(q1) - 2*Ipy*q2_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)^2*sin(q2) - 2*Ipy*q3_d*q5_d*cos(q1)^2*cos(q2)^2*cos(q5)*sin(q5) + 2*Ipz*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2*sin(q1) + 2*Ipz*q2_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)^2*sin(q2) + 2*Ipz*q3_d*q5_d*cos(q1)^2*cos(q2)^2*cos(q5)*sin(q5) - 2*Lc*Lcp*Mp*q1_d^2*cos(q2)*sin(q1)*sin(q2) - Lc*Lp*Mp*q1_d^2*cos(q1)*sin(q2)*sin(q5) + Lc*Lp*Mp*q2_d^2*cos(q1)*sin(q2)*sin(q5) - Lc*Lp*Mp*q5_d^2*cos(q1)*sin(q2)*sin(q5) - Lcp*Lp*Mp*q1_d^2*cos(q1)*sin(q2)*sin(q5) + Lcp*Lp*Mp*q2_d^2*cos(q1)*sin(q2)*sin(q5) - Lcp*Lp*Mp*q5_d^2*cos(q1)*sin(q2)*sin(q5) - Lp*Mp*Rw*q1_d^2*cos(q5)*sin(q1)*sin(q2) + Lp*Mp*Rw*q2_d^2*cos(q5)*sin(q1)*sin(q2) + Lp*Mp*Rw*q5_d^2*cos(q5)*sin(q1)*sin(q2) + 2*Lp^2*Mp*q3_d*q5_d*cos(q1)*cos(q2)*sin(q1) + 2*Lp^2*Mp*q1_d*q3_d*cos(q2)*cos(q5)*sin(q5) - 4*Lc*Lp*Mp*q1_d*q2_d*cos(q1)*cos(q5) - 4*Lcp*Lp*Mp*q1_d*q2_d*cos(q1)*cos(q5) + 2*Lp^2*Mp*q2_d*q5_d*cos(q5)*sin(q1)*sin(q5) + 2*Lc*Lp*Mp*q1_d*q3_d*cos(q2)*sin(q5) + 2*Lcp*Lp*Mp*q1_d*q3_d*cos(q2)*sin(q5) + 2*Lp*Mp*Rw*q2_d*q3_d*cos(q5)*sin(q2) - Lp*Mp*Rw*q3_d*q4_d*cos(q5)*sin(q2) + 2*Lp*Mp*Rw*q3_d*q5_d*cos(q2)*sin(q5) + 2*Lc*Lp*Mp*q2_d*q5_d*sin(q1)*sin(q5) + 2*Lcp*Lp*Mp*q2_d*q5_d*sin(q1)*sin(q5) - Lp^2*Mp*q1_d^2*cos(q2)*cos(q5)^2*sin(q1)*sin(q2) + 4*Lc*Lp*Mp*q1_d*q2_d*cos(q1)*cos(q2)^2*cos(q5) + 4*Lcp*Lp*Mp*q1_d*q2_d*cos(q1)*cos(q2)^2*cos(q5) - 4*Lc*Lcp*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*sin(q1) - 4*Lc*Lcp*Mp*q2_d*q3_d*cos(q1)^2*cos(q2)*sin(q2) - 4*Lc*Lp*Mp*q1_d*q3_d*cos(q1)^2*cos(q2)*sin(q5) - 4*Lcp*Lp*Mp*q1_d*q3_d*cos(q1)^2*cos(q2)*sin(q5) - 2*Lp*Mp*Rw*q2_d*q3_d*cos(q1)^2*cos(q5)*sin(q2) - 2*Lp*Mp*Rw*q3_d*q5_d*cos(q1)^2*cos(q2)*sin(q5) - 2*Lp^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)^2*sin(q1) - 2*Lp^2*Mp*q2_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)^2*sin(q2) - 2*Lp^2*Mp*q3_d*q5_d*cos(q1)^2*cos(q2)^2*cos(q5)*sin(q5) - 2*Lc*Lp*Mp*q3_d*q5_d*cos(q1)^2*cos(q2)^2*sin(q5) - 2*Lcp*Lp*Mp*q3_d*q5_d*cos(q1)^2*cos(q2)^2*sin(q5) - 2*Lc*Lp*Mp*q1_d^2*cos(q2)*cos(q5)*sin(q1)*sin(q2) - 2*Lcp*Lp*Mp*q1_d^2*cos(q2)*cos(q5)*sin(q1)*sin(q2) - 4*Lc*Mc*Rw*q1_d*q3_d*cos(q1)*cos(q2)*sin(q1) - 4*Lc*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2)*sin(q1) - 4*Lcp*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2)*sin(q1) - 2*Lp*Mp*Rw*q3_d*q5_d*cos(q1)*cos(q5)*sin(q1) - 2*Lc*Lp*Mp*q1_d*q5_d*cos(q5)*sin(q1)*sin(q2) - 2*Lcp*Lp*Mp*q1_d*q5_d*cos(q5)*sin(q1)*sin(q2) + 2*Lp*Mp*Rw*q2_d*q5_d*cos(q2)*sin(q1)*sin(q5) - 2*Ipy*q1_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) + 2*Ipz*q1_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) + 2*Ipy*q2_d*q3_d*cos(q1)*cos(q5)*sin(q1)*sin(q2)*sin(q5) - 2*Ipz*q2_d*q3_d*cos(q1)*cos(q5)*sin(q1)*sin(q2)*sin(q5) - 4*Lp^2*Mp*q1_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)*sin(q5) - 4*Lp^2*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)^2*sin(q1) - 2*Lp^2*Mp*q1_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) - 2*Lc*Lp*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q1) - 2*Lcp*Lp*Mp*q3_d*q5_d*cos(q1)*cos(q2)*cos(q5)*sin(q1) - 4*Lp*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2)*cos(q5)*sin(q1) + 2*Lp^2*Mp*q2_d*q3_d*cos(q1)*cos(q5)*sin(q1)*sin(q2)*sin(q5) - 2*Lc*Lp*Mp*q1_d*q5_d*cos(q1)*cos(q2)*sin(q2)*sin(q5) - 2*Lcp*Lp*Mp*q1_d*q5_d*cos(q1)*cos(q2)*sin(q2)*sin(q5) + 2*Lc*Lp*Mp*q2_d*q3_d*cos(q1)*sin(q1)*sin(q2)*sin(q5) + 2*Lcp*Lp*Mp*q2_d*q3_d*cos(q1)*sin(q1)*sin(q2)*sin(q5) - 4*Lc*Lp*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)*sin(q1) - 4*Lc*Lp*Mp*q2_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)*sin(q2) - 4*Lcp*Lp*Mp*q1_d*q3_d*cos(q1)*cos(q2)^2*cos(q5)*sin(q1) - 4*Lcp*Lp*Mp*q2_d*q3_d*cos(q1)^2*cos(q2)*cos(q5)*sin(q2);    
            Tw - Iwy*q1_d*q3_d*cos(q1) + Lc*Mc*Rw*q2_d^2*sin(q2) + Lc*Mc*Rw*q3_d^2*sin(q2) + Lc*Mp*Rw*q2_d^2*sin(q2) + Lc*Mp*Rw*q3_d^2*sin(q2) + Lcp*Mp*Rw*q2_d^2*sin(q2) + Lcp*Mp*Rw*q3_d^2*sin(q2) - 2*Mc*Rw^2*q1_d*q3_d*cos(q1) - 2*Mp*Rw^2*q1_d*q3_d*cos(q1) - 2*Mw*Rw^2*q1_d*q3_d*cos(q1) + Lp*Mp*Rw*q2_d^2*cos(q5)*sin(q2) + Lp*Mp*Rw*q3_d^2*cos(q5)*sin(q2) + Lp*Mp*Rw*q5_d^2*cos(q5)*sin(q2) - 2*Lc*Mc*Rw*q1_d*q3_d*cos(q1)*cos(q2) - 2*Lc*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2) - 2*Lcp*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2) - 2*Lp*Mp*Rw*q3_d*q5_d*cos(q1)*cos(q5) + 2*Lp*Mp*Rw*q2_d*q5_d*cos(q2)*sin(q5) + 2*Lc*Mc*Rw*q2_d*q3_d*sin(q1)*sin(q2) + 2*Lc*Mp*Rw*q2_d*q3_d*sin(q1)*sin(q2) + 2*Lcp*Mp*Rw*q2_d*q3_d*sin(q1)*sin(q2) + 2*Lp*Mp*Rw*q1_d*q3_d*sin(q1)*sin(q5) - 2*Lp*Mp*Rw*q1_d*q3_d*cos(q1)*cos(q2)*cos(q5) + 2*Lp*Mp*Rw*q2_d*q3_d*cos(q5)*sin(q1)*sin(q2) + 2*Lp*Mp*Rw*q3_d*q5_d*cos(q2)*sin(q1)*sin(q5);        
            Tp + (Ipy*q1_d^2*sin(2*q5))/2 - (Ipy*q2_d^2*sin(2*q5))/2 - (Ipy*q3_d^2*sin(2*q5))/2 - (Ipz*q1_d^2*sin(2*q5))/2 + (Ipz*q2_d^2*sin(2*q5))/2 + (Ipz*q3_d^2*sin(2*q5))/2 + (Lp^2*Mp*q1_d^2*sin(2*q5))/2 - (Lp^2*Mp*q2_d^2*sin(2*q5))/2 - (Lp^2*Mp*q3_d^2*sin(2*q5))/2 + Ipx*q1_d*q2_d*sin(q2) - Ipy*q1_d*q2_d*sin(q2) + Ipz*q1_d*q2_d*sin(q2) - Ipy*q3_d^2*cos(q1)*cos(q2)*sin(q1) + Ipz*q3_d^2*cos(q1)*cos(q2)*sin(q1) + Lp*Mp*g*cos(q5)*sin(q1) + Ipx*q2_d*q3_d*cos(q1)*cos(q2) - Ipy*q2_d*q3_d*cos(q1)*cos(q2) + Ipz*q2_d*q3_d*cos(q1)*cos(q2) - Ipx*q1_d*q3_d*sin(q1)*sin(q2) - Ipy*q1_d*q3_d*sin(q1)*sin(q2) + Ipz*q1_d*q3_d*sin(q1)*sin(q2) - Ipy*q1_d^2*cos(q2)^2*cos(q5)*sin(q5) + Ipy*q3_d^2*cos(q1)^2*cos(q5)*sin(q5) + Ipz*q1_d^2*cos(q2)^2*cos(q5)*sin(q5) - Ipz*q3_d^2*cos(q1)^2*cos(q5)*sin(q5) + 2*Ipy*q1_d*q2_d*cos(q5)^2*sin(q2) - 2*Ipz*q1_d*q2_d*cos(q5)^2*sin(q2) - Lc*Lp*Mp*q2_d^2*sin(q5) - Lc*Lp*Mp*q3_d^2*sin(q5) - Lcp*Lp*Mp*q2_d^2*sin(q5) - Lcp*Lp*Mp*q3_d^2*sin(q5) - 2*Lp^2*Mp*q1_d*q3_d*sin(q1)*sin(q2) - Lp^2*Mp*q1_d^2*cos(q2)^2*cos(q5)*sin(q5) + Lp^2*Mp*q3_d^2*cos(q1)^2*cos(q5)*sin(q5) - 2*Ipy*q2_d*q3_d*cos(q5)*sin(q1)*sin(q5) + 2*Ipz*q2_d*q3_d*cos(q5)*sin(q1)*sin(q5) - Lc*Lp*Mp*q1_d^2*cos(q2)^2*sin(q5) - Lcp*Lp*Mp*q1_d^2*cos(q2)^2*sin(q5) + 2*Ipy*q3_d^2*cos(q1)*cos(q2)*cos(q5)^2*sin(q1) - 2*Ipz*q3_d^2*cos(q1)*cos(q2)*cos(q5)^2*sin(q1) + 2*Lp^2*Mp*q1_d*q2_d*cos(q5)^2*sin(q2) + 2*Ipy*q2_d*q3_d*cos(q1)*cos(q2)*cos(q5)^2 - 2*Ipz*q2_d*q3_d*cos(q1)*cos(q2)*cos(q5)^2 + 2*Ipy*q1_d*q3_d*cos(q5)^2*sin(q1)*sin(q2) - 2*Ipz*q1_d*q3_d*cos(q5)^2*sin(q1)*sin(q2) + Ipy*q3_d^2*cos(q1)^2*cos(q2)^2*cos(q5)*sin(q5) - Ipz*q3_d^2*cos(q1)^2*cos(q2)^2*cos(q5)*sin(q5) - Lp^2*Mp*q3_d^2*cos(q1)*cos(q2)*sin(q1) - Lp*Mp*Rw*q1_d^2*cos(q2)*sin(q5) - Lp*Mp*Rw*q3_d^2*cos(q2)*sin(q5) + Lp*Mp*g*cos(q1)*cos(q2)*sin(q5) + Lp*Mp*Rw*q3_d^2*cos(q1)^2*cos(q2)*sin(q5) + 2*Lp^2*Mp*q2_d*q3_d*cos(q1)*cos(q2)*cos(q5)^2 + 2*Lp^2*Mp*q1_d*q3_d*cos(q5)^2*sin(q1)*sin(q2) + Lp^2*Mp*q3_d^2*cos(q1)^2*cos(q2)^2*cos(q5)*sin(q5) + Lc*Lp*Mp*q3_d^2*cos(q1)^2*cos(q2)^2*sin(q5) + Lcp*Lp*Mp*q3_d^2*cos(q1)^2*cos(q2)^2*sin(q5) + Lp*Mp*Rw*q3_d^2*cos(q1)*cos(q5)*sin(q1) + Lp*Mp*Rw*q3_d*q4_d*cos(q1)*cos(q5) - 2*Lp^2*Mp*q2_d*q3_d*cos(q5)*sin(q1)*sin(q5) + 2*Lc*Lp*Mp*q1_d*q2_d*cos(q5)*sin(q2) + 2*Lcp*Lp*Mp*q1_d*q2_d*cos(q5)*sin(q2) + 2*Lp^2*Mp*q3_d^2*cos(q1)*cos(q2)*cos(q5)^2*sin(q1) - 2*Lc*Lp*Mp*q2_d*q3_d*sin(q1)*sin(q5) - 2*Lcp*Lp*Mp*q2_d*q3_d*sin(q1)*sin(q5) + Lc*Lp*Mp*q3_d^2*cos(q1)*cos(q2)*cos(q5)*sin(q1) + Lcp*Lp*Mp*q3_d^2*cos(q1)*cos(q2)*cos(q5)*sin(q1) + 2*Lc*Lp*Mp*q2_d*q3_d*cos(q1)*cos(q2)*cos(q5) + 2*Lcp*Lp*Mp*q2_d*q3_d*cos(q1)*cos(q2)*cos(q5) + 2*Lp*Mp*Rw*q1_d*q3_d*cos(q1)*sin(q2)*sin(q5) - Lp*Mp*Rw*q3_d*q4_d*cos(q2)*sin(q1)*sin(q5) + 2*Ipy*q1_d*q3_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) - 2*Ipz*q1_d*q3_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) + 2*Lp^2*Mp*q1_d*q3_d*cos(q1)*cos(q2)*cos(q5)*sin(q2)*sin(q5) + 2*Lc*Lp*Mp*q1_d*q3_d*cos(q1)*cos(q2)*sin(q2)*sin(q5) + 2*Lcp*Lp*Mp*q1_d*q3_d*cos(q1)*cos(q2)*sin(q2)*sin(q5)];

% Put in system values
constants = [Mw; Mc; Mp;...
             Iwx; Iwy; Iwz;...
             Icx; Icy; Icz;...
             Ipx; Ipy; Ipz;...
             Rw; Lc; Lcp; Lp; g];
M = subs(M, constants, const_values);
RHS = subs(RHS, constants, const_values);

% Linearize the model
%q_all = [q1; q2; q5; q1_d; q2_d; q5_d]; % All terms that will be neglected if they appear as a product
q_all = [q_v; dq_v];
M_tmp1  = subs(M, [sin(q_v) sin(2*q_v) cos(q_v) cos(2*q_v)], [q_v, 2*q_v, ones(length(q_v),1), ones(length(q_v),1)]);
RHS_tmp1  = subs(RHS, [sin(q_v) sin(2*q_v) cos(q_v) cos(2*q_v)], [q_v, 2*q_v, ones(length(q_v),1), ones(length(q_v),1)]);

% Set terms of higher order (>2) to zero
tmp = nchoosek(q_all, 3);
tmp2 = [];
for i=1:length(tmp)
    tmp2 = [tmp2, tmp(i, 1)*tmp(i, 2)*tmp(i, 3)];
end
tmp = nchoosek(q_all, 2);

M_tmp2 = subs(M_tmp1, [tmp2], [zeros(1, length(tmp2))]);
RHS_tmp2 = subs(RHS_tmp1, [tmp2], [zeros(1, length(tmp2))]);

M_linearized = simplify(collect(simplify(M_tmp2,'Steps',30),[ddq_v]),300);
RHS_linearized = simplify(collect(simplify(RHS_tmp2,'Steps',30),[ddq_v]),300);

%% Wheel-Pitch dynamics
% State: q2 = Pitch, q4 = Wheel
M_pitch = double([[M_linearized(2,2), M_linearized(2,4)];...
           [M_linearized(4,2), M_linearized(4,4)]]);
RHS_pitch = [RHS_linearized(2);...
             RHS_linearized(4)];
ddq_p = inv(M_pitch)*RHS_pitch;
a21 = subs(ddq_p(1), [q2, q1_d, q2_d, q3_d, q5_d, Tw], [1, 0, 0, 0, 0, 0]);
b2 = subs(ddq_p(1), [q2, q1_d, q2_d, q3_d, q5_d, Tw], [0, 0, 0, 0, 0, 1]);
a41 = subs(ddq_p(2), [q2, q1_d, q2_d, q3_d, q5_d, Tw], [1, 0, 0, 0, 0, 0]);
b4 = subs(ddq_p(2), [q2, q1_d, q2_d, q3_d, q5_d, Tw], [0, 0, 0, 0, 0, 1]);

% Setup linear system with [dz1=ddq2, z1=dq2, dz2=ddq4, z2=dq4]
Ap = double([[0, 1, 0, 0];...
            [a21, 0, 0, 0];...
            [0, 0, 0, 1];...
            [a41, 0, 0, 0]]);
Bp = double([0; b2; 0; b4]);

states = {'dq2' 'q2' 'dq4' 'q4'};
inputs = {'u_wheel'};

sysp = ss(Ap,Bp,eye(4),zeros(4,1), 'statename',states,'inputname',inputs, 'outputname',states); % Create state space model
sysp_d = c2d(sysp,Ts,'zoh'); % Convert to discrete, where dt is your discrete time-step (in seconds)

%% Flywheel-Roll dynamics
% State: q1 = Roll, q5 = Flywheel angle
M_roll = double([[M_linearized(1,1), M_linearized(1,5)];
                 [M_linearized(5,1), M_linearized(5,5)]]);
RHS_roll = [RHS_linearized(1);...
            RHS_linearized(5)];       
ddq_r = inv(M_roll)*RHS_roll;
a21r = subs(ddq_r(1), [q1, q1_d, q2_d, q3_d, q5_d, Tp], [1, 0, 0, 0, 0, 0]);
b2r = subs(ddq_r(1), [q1, q1_d, q2_d, q3_d, q5_d, Tp], [0, 0, 0, 0, 0, 1]);
a41r = subs(ddq_r(2), [q1, q1_d, q2_d, q3_d, q5_d, Tp], [1, 0, 0, 0, 0, 0]);
b4r = subs(ddq_r(2), [q1, q1_d, q2_d, q3_d, q5_d, Tp], [0, 0, 0, 0, 0, 1]);

% Setup linear system with [dz1=ddq2, z1=dq2, dz2=ddq5, z2=dq5]
Ar = double([[0, 1, 0, 0];...
            [a21r, 0, 0, 0];...
            [0, 0, 0, 1];...
            [a41r, 0, 0, 0]]);
Br = double([0; b2r; 0; b4r]);

states_r = {'dq1' 'q1' 'dq5' 'q5'};
inputs_r = {'u_flywheel'};

sysr = ss(Ar,Br,eye(4),zeros(4,1), 'statename',states_r,'inputname',inputs_r, 'outputname',states_r); % Create state space model
sysr_d = c2d(sysr,Ts,'zoh'); % Convert to discrete, where dt is your discrete time-step (in seconds)

%% LQR weighting matrices

% state = [q2, q2d, q4, q4d]
Qp = diag([100,1e-10,0.00001,10]); 
Rp = 10000;
Kp = dlqr(sysp_d.a, sysp_d.b, Qp, Rp);
gain_int_pitch = 1e-10; 
save('./parameters/Kp.mat', 'Kp')

% state = [q1, q1d, q5, q5d]
Qr = diag([100,0.01,0.1,0.1]); %final
gain_int_roll = 1e-10;
Rr = 1000;
Kr = dlqr(sysr_d.a, sysr_d.b, Qr, Rr);
save('./parameters/Kr.mat', 'Kr')


%% Compute feedforward term
Ap_cl = Ap - Bp*Kp; % Matlab lqr convention requires minus!
Mp = (((eye(4) - Ap_cl)\eye(4))*Bp)\eye(4);
%Mp2 = pinv(pinv(eye(4) - Ap_cl)*Bp);
save('./parameters/Mp.mat', 'Mp')

Ar_cl = Ar - Br*Kr; % Matlab lqr convention requires minus!
Mr = (((eye(4) - Ar_cl)\eye(4))*Br)\eye(4);
save('./parameters/Mr.mat', 'Mr')